<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PAI Dashboard</title>
  <style>
    :root {
      /* PAI Brand Colors */
      --pai-orange: #FF6B35;
      --pai-orange-light: #FF8C61;
      --pai-orange-dark: #E55A2B;
      --pai-orange-glow: rgba(255, 107, 53, 0.4);

      --pai-black: #000000;
      --pai-black-soft: #0a0a0a;
      --pai-black-rich: #111111;

      --pai-gray-100: #f5f5f5;
      --pai-gray-400: #a3a3a3;
      --pai-gray-500: #737373;
      --pai-gray-600: #525252;
      --pai-gray-700: #404040;
      --pai-gray-800: #262626;
      --pai-gray-900: #171717;

      --pai-white: #FFFFFF;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--pai-black);
      color: var(--pai-white);
      min-height: 100vh;
      padding: 24px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--pai-gray-700);
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      color: var(--pai-orange);
    }

    .header .subtitle {
      color: var(--pai-gray-400);
      font-size: 14px;
    }

    .refresh-btn {
      background: var(--pai-orange);
      color: var(--pai-black);
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    .refresh-btn:hover {
      background: var(--pai-orange-light);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .card {
      background: var(--pai-gray-900);
      border: 1px solid var(--pai-gray-700);
      border-radius: 12px;
      padding: 20px;
    }

    .card-header {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--pai-gray-400);
      margin-bottom: 8px;
    }

    .card-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--pai-white);
    }

    .card-value.orange {
      color: var(--pai-orange);
    }

    .section {
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--pai-white);
      margin-bottom: 16px;
      padding-left: 12px;
      border-left: 3px solid var(--pai-orange);
    }

    .chart-container {
      background: var(--pai-gray-900);
      border: 1px solid var(--pai-gray-700);
      border-radius: 12px;
      padding: 24px;
    }

    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bar-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .bar-label {
      width: 100px;
      font-size: 13px;
      color: var(--pai-gray-100);
      text-align: right;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .bar-container {
      flex: 1;
      height: 28px;
      background: var(--pai-gray-800);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--pai-orange-dark), var(--pai-orange));
      border-radius: 4px;
      transition: width 0.5s ease-out;
      position: relative;
    }

    .bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 4px;
      background: var(--pai-orange-light);
      box-shadow: 0 0 10px var(--pai-orange-glow);
    }

    .bar-count {
      width: 60px;
      font-size: 14px;
      font-weight: 600;
      color: var(--pai-orange);
      font-family: 'SF Mono', Monaco, monospace;
    }

    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .two-col {
        grid-template-columns: 1fr;
      }
    }

    .agent-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .agent-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--pai-gray-800);
      border-radius: 8px;
    }

    .agent-name {
      font-size: 14px;
      color: var(--pai-white);
    }

    .agent-count {
      font-size: 14px;
      font-weight: 600;
      color: var(--pai-orange);
      background: rgba(255, 107, 53, 0.15);
      padding: 4px 10px;
      border-radius: 12px;
    }

    .token-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .token-stat {
      padding: 16px;
      background: var(--pai-gray-800);
      border-radius: 8px;
    }

    .token-label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--pai-gray-400);
      margin-bottom: 4px;
    }

    .token-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--pai-white);
    }

    .hour-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 4px;
    }

    .hour-cell {
      aspect-ratio: 1;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--pai-gray-400);
      position: relative;
    }

    .hour-cell::after {
      content: attr(data-hour);
      position: absolute;
      bottom: -16px;
      font-size: 9px;
      color: var(--pai-gray-500);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--pai-gray-400);
    }

    .footer {
      text-align: center;
      padding: 24px;
      color: var(--pai-gray-500);
      font-size: 12px;
      border-top: 1px solid var(--pai-gray-800);
      margin-top: 40px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>PAI Dashboard</h1>
      <div class="subtitle">Personal AI Infrastructure Usage Metrics</div>
    </div>
    <button class="refresh-btn" onclick="loadData()">Refresh</button>
  </div>

  <div id="content">
    <div class="loading">Loading dashboard data...</div>
  </div>

  <div class="footer">
    PAI Dashboard &bull; Data from ~/.claude
  </div>

  <script>
    function formatNumber(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return n.toString();
    }

    function getHeatColor(value, max) {
      if (value === 0) return 'var(--pai-gray-800)';
      const intensity = Math.min(value / max, 1);
      const alpha = 0.3 + (intensity * 0.7);
      return `rgba(255, 107, 53, ${alpha})`;
    }

    async function loadData() {
      try {
        const response = await fetch('/api/all');
        const data = await response.json();
        renderDashboard(data);
      } catch (error) {
        document.getElementById('content').innerHTML = `
          <div class="loading">Error loading data: ${error.message}</div>
        `;
      }
    }

    function renderDashboard(data) {
      const { stats, events, agents } = data;

      // Calculate totals
      const totalSessions = stats?.totalSessions || 0;
      const totalMessages = stats?.totalMessages || 0;
      const totalToolCalls = Object.values(events?.toolCounts || {}).reduce((a, b) => a + b, 0);

      // Token stats
      const modelUsage = stats?.modelUsage || {};
      let totalInput = 0, totalOutput = 0, totalCacheRead = 0;
      for (const model of Object.values(modelUsage)) {
        totalInput += model.inputTokens || 0;
        totalOutput += model.outputTokens || 0;
        totalCacheRead += model.cacheReadInputTokens || 0;
      }

      // Tool counts sorted
      const toolCounts = events?.toolCounts || {};
      const sortedTools = Object.entries(toolCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 12);
      const maxToolCount = sortedTools[0]?.[1] || 1;

      // Agent counts
      const agentCounts = {};
      for (const type of Object.values(agents || {})) {
        agentCounts[type] = (agentCounts[type] || 0) + 1;
      }
      const sortedAgents = Object.entries(agentCounts).sort((a, b) => b[1] - a[1]);

      // Hour counts
      const hourCounts = stats?.hourCounts || {};
      const maxHour = Math.max(...Object.values(hourCounts), 1);

      const html = `
        <!-- Overview Cards -->
        <div class="grid">
          <div class="card">
            <div class="card-header">Total Sessions</div>
            <div class="card-value orange">${totalSessions}</div>
          </div>
          <div class="card">
            <div class="card-header">Total Messages</div>
            <div class="card-value">${formatNumber(totalMessages)}</div>
          </div>
          <div class="card">
            <div class="card-header">Tool Calls</div>
            <div class="card-value">${formatNumber(totalToolCalls)}</div>
          </div>
          <div class="card">
            <div class="card-header">Cache Hit Rate</div>
            <div class="card-value orange">${totalCacheRead > 0 ? Math.round((totalCacheRead / (totalCacheRead + totalInput)) * 100) : 0}%</div>
          </div>
        </div>

        <!-- Tool Usage -->
        <div class="section">
          <div class="section-title">Tool Usage Breakdown</div>
          <div class="chart-container">
            <div class="bar-chart">
              ${sortedTools.map(([tool, count]) => `
                <div class="bar-row">
                  <div class="bar-label">${tool}</div>
                  <div class="bar-container">
                    <div class="bar-fill" style="width: ${(count / maxToolCount) * 100}%"></div>
                  </div>
                  <div class="bar-count">${count}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>

        <div class="two-col">
          <!-- Agent Analytics -->
          <div class="section">
            <div class="section-title">Agent Types</div>
            <div class="chart-container">
              <div class="agent-list">
                ${sortedAgents.length > 0 ? sortedAgents.map(([agent, count]) => `
                  <div class="agent-item">
                    <span class="agent-name">${agent}</span>
                    <span class="agent-count">${count}</span>
                  </div>
                `).join('') : '<div style="color: var(--pai-gray-400)">No agent data</div>'}
              </div>
            </div>
          </div>

          <!-- Token Economics -->
          <div class="section">
            <div class="section-title">Token Usage</div>
            <div class="chart-container">
              <div class="token-stats">
                <div class="token-stat">
                  <div class="token-label">Input Tokens</div>
                  <div class="token-value">${formatNumber(totalInput)}</div>
                </div>
                <div class="token-stat">
                  <div class="token-label">Output Tokens</div>
                  <div class="token-value">${formatNumber(totalOutput)}</div>
                </div>
                <div class="token-stat">
                  <div class="token-label">Cache Read</div>
                  <div class="token-value">${formatNumber(totalCacheRead)}</div>
                </div>
                <div class="token-stat">
                  <div class="token-label">Total Tokens</div>
                  <div class="token-value" style="color: var(--pai-orange)">${formatNumber(totalInput + totalOutput + totalCacheRead)}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Activity Heatmap -->
        <div class="section">
          <div class="section-title">Hourly Activity</div>
          <div class="chart-container">
            <div class="hour-grid">
              ${Array.from({length: 24}, (_, h) => {
                const count = hourCounts[h] || 0;
                return `<div class="hour-cell" style="background: ${getHeatColor(count, maxHour)}" data-hour="${h}:00" title="${count} sessions at ${h}:00">${count || ''}</div>`;
              }).join('')}
            </div>
          </div>
        </div>
      `;

      document.getElementById('content').innerHTML = html;
    }

    // Load on page load
    loadData();
  </script>
</body>
</html>
